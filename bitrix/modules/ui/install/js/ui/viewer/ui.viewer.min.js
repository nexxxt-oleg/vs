(function(){"use strict";BX.namespace("BX.UI.Viewer");BX.UI.Viewer.Controller=function(e){this.items=null;this.currentIndex=null;this.handlers={};this.setItems(e.items||[]);this.zIndex=e.zIndex||999999;this.cycleMode=e.hasOwnProperty("cycleMode")?e.cycleMode:true;this.optionsByGroup={};this.layout={container:null,content:null,inner:null,itemContainer:null,next:null,prev:null,close:null,error:null,loader:null,loaderContainer:null,loaderText:null,panel:null};this.actionPanel=new BX.UI.ActionPanel({darkMode:true,floatMode:false,autoHide:false,zIndex:this.zIndex,showTotalSelectedBlock:false,showResetAllBlock:false,alignItems:"center",renderTo:function(){return this.getPanelWrapper()}.bind(this)});this.init()};BX.UI.Viewer.Controller.prototype={buildItemListByNode:function(e){if(!BX.type.isDomNode(e)||!e.dataset){return[]}if(!e.dataset.hasOwnProperty("viewer")){return[]}if(!e.dataset.viewerGroupBy){return[BX.UI.Viewer.buildItemByNode(e)]}var t=[].slice.call(e.ownerDocument.querySelectorAll("[data-viewer][data-viewer-group-by='"+e.dataset.viewerGroupBy+"']"));return t.map(function(e){return BX.UI.Viewer.buildItemByNode(e)})},handleDocumentClick:function(e){var t=BX.getEventTarget(e);var i=this.buildItemListByNode(t);if(i.length===0){return}this.setItems(i).then(function(){this.open(this.getIndexByNode(t))}.bind(this));e.preventDefault()},bindEvents:function(){this.handlers.keyPress=this.handleKeyPress.bind(this);this.handlers.touchStart=this.handleTouchStart.bind(this);this.handlers.touchEnd=this.handleTouchEnd.bind(this);this.handlers.resize=this.adjustViewerHeight.bind(this);this.handlers.showNext=this.showNext.bind(this);this.handlers.showPrev=this.showPrev.bind(this);this.handlers.close=this.close.bind(this);this.handlers.handleClickOnItemContainer=this.handleClickOnItemContainer.bind(this);this.handlers.handleSliderOpen=this.handleSliderOpen.bind(this);this.handlers.handleSliderCloseComplete=this.handleSliderCloseComplete.bind(this);this.handlers.handleSliderCloseByEsc=this.handleSliderCloseByEsc.bind(this);BX.bind(document,"keydown",this.handlers.keyPress);BX.bind(window,"resize",this.handlers.resize);BX.bind(this.getItemContainer(),"touchstart",this.handlers.touchStart);BX.bind(this.getItemContainer(),"touchend",this.handlers.touchEnd);BX.bind(this.getItemContainer(),"click",this.handlers.handleClickOnItemContainer);BX.bind(this.getNextButton(),"click",this.handlers.showNext);BX.bind(this.getPrevButton(),"click",this.handlers.showPrev);BX.bind(this.getCloseButton(),"click",this.handlers.close);BX.addCustomEvent("SidePanel.Slider:onOpen",this.handlers.handleSliderOpen);BX.addCustomEvent("SidePanel.Slider:onCloseComplete",this.handlers.handleSliderCloseComplete);BX.addCustomEvent("SidePanel.Slider:onCloseByEsc",this.handlers.handleSliderCloseByEsc)},handleSliderCloseByEsc:function(e){if(this.isOpen()&&this.getZindex()>e.getSlider().getZindex()){e.denyAction()}},handleSliderCloseComplete:function(e){var t=BX.SidePanel.Instance.getTopSlider();if(t){console.log("grab zIndex from closed slider",t.getZindex());this.setZindex(t.getZindex()-1)}else{console.log("reset zIndex by originalZIndex",this.originalZIndex);this.setZindex(this.originalZIndex);this.originalZIndex=null}},handleSliderOpen:function(e){if(!this.originalZIndex){this.originalZIndex=this.getZindex()}console.log("SidePanel.Slider:onOpen",this.originalZIndex,e.getSlider().getZindex()-1);this.setZindex(e.getSlider().getZindex()-1)},adjustZindex:function(){if(!BX.getClass("BX.SidePanel.Instance")){return}if(!BX.SidePanel.Instance.isOpen()){this.setZindex(this.originalZIndex||this.zIndex);this.originalZIndex=null;return}var e=BX.SidePanel.Instance.getTopSlider();this.originalZIndex=this.zIndex;this.setZindex(e.getZindex()+1)},unbindEvents:function(){BX.unbind(document,"keydown",this.handlers.keyPress);BX.unbind(window,"resize",this.handlers.resize);BX.unbind(this.getItemContainer(),"touchstart",this.handlers.touchStart);BX.unbind(this.getItemContainer(),"touchend",this.handlers.touchEnd);BX.unbind(this.getItemContainer(),"click",this.handlers.handleClickOnItemContainer);BX.unbind(this.getNextButton(),"click",this.handlers.showNext);BX.unbind(this.getPrevButton(),"click",this.handlers.showPrev);BX.unbind(this.getCloseButton(),"click",this.handlers.close);BX.removeCustomEvent("SidePanel.Slider:onOpen",this.handlers.handleSliderOpen);BX.removeCustomEvent("SidePanel.Slider:onCloseComplete",this.handlers.handleSliderCloseComplete)},init:function(){},openByNode:function(e){var t=this.buildItemListByNode(e);if(t.length===0){return}this.setItems(t).then(function(){this.open(this.getIndexByNode(e))}.bind(this))},runActionByNode:function(e,t,i){var n=this.buildItemListByNode(e);if(n.length===0){return}this.setItems(n).then(function(){this.runAction(this.getIndexByNode(e),t,i)}.bind(this))},runAction:function(e,t,i){var n=this.getItemByIndex(e);var o=n.getActions().find(function(e){return e.id===t});console.log("actionToRun",t,o);if(!BX.type.isFunction(o.action)){console.log("action is not a function");return}o.action.call(this,n,i)},getZindex:function(){return this.zIndex},setZindex:function(e){console.log("setZindex",e);this.zIndex=e;this.getViewerContainer().style.zIndex=e},setItems:function(e){if(!BX.type.isArray(e)){throw new Error("BX.UI.Viewer.Controller.setItems: 'items' has to be Array.")}BX.onCustomEvent("BX.UI.Viewer.Controller:onSetItems",[this,e]);this.items=e;this.items.forEach(function(e){e.setController(this)},this);return this.loadExtensions(this.collectExtensionsForAction(e))},loadExtensions:function(e){return BX.loadExt(e)},collectExtensionsForAction:function(e){var t=new Set;e.forEach(function(e){var i=e.getActions()||[];i.forEach(function(e){if(!e.extension){return}if(!BX.type.isArray(e.extension)){e.extension=[e.extension]}e.extension.forEach(function(e){t.add(e)})})});var i=[];t.forEach(function(e){i.push(e)});return i},appendItem:function(e){if(!(e instanceof BX.UI.Viewer.Item)){throw new Error("BX.UI.Viewer.Controller.appendItem: 'item' has to be instance of BX.UI.Viewer.Item.")}e.setController(this);this.items.push(e)},reloadItem:function(e,t){t=t||{};if(!(e instanceof BX.UI.Viewer.Item)){throw new Error("BX.UI.Viewer.Controller.reloadItem: 'item' has to be instance of BX.UI.Viewer.Item.")}var i=this.items.indexOf(e);if(i===-1){throw new Error("BX.UI.Viewer.Controller.reloadItem: there is no 'item' in items to reload.")}var n=null;if(e.sourceNode){n=BX.UI.Viewer.buildItemByNode(e.sourceNode)}else{n=new e.constructor(e.options)}n.setController(this);n.applyReloadOptions(t);this.items[i]=n},show:function(e){if(typeof e==="undefined"){e=0}BX.onCustomEvent("BX.UI.Viewer.Controller:onBeforeShow",[this,e]);var t=this.getItemByIndex(e);if(!t){return}this.currentIndex=e;this.hideErrorBlock();this.hideCurrentItem();this.showLoading();this.actionPanel.removeItems();this.actionPanel.addItems(this.convertItemActionsToPanelItems(this.getCurrentItem()));t.load().then(function(e){if(this.getCurrentItem()===e){console.log("show item");this.processShowItem(e)}}.bind(this)).catch(function(e){var t=e.item;console.log("catch viewer");BX.onCustomEvent("BX.UI.Viewer.Controller:onItemError",[this,e,t]);if(this.getCurrentItem()===t){this.processError(e,t)}BX.onCustomEvent("BX.UI.Viewer.Controller:onAfterProcessItemError",[this,e,t])}.bind(this));this.updateControls();this.lockScroll();this.adjustViewerHeight()},reload:function(e,t){var i=this.getCurrentItem()===e;this.reloadItem(e,t);if(i){console.log("reload");this.show(this.currentIndex)}},reloadCurrentItem:function(e){this.reload(this.getCurrentItem(),e||{})},processShowItem:function(e){this.hideCurrentItem();this.hideLoading();var t=BX.create("div",{props:{className:"ui-viewer-inner-content-wrapper"}});var i=document.createDocumentFragment();i.appendChild(e.render());var n=e.getTitle();if(n){i.appendChild(BX.create("div",{props:{className:"viewer-inner-caption"},text:n}))}t.appendChild(i);this.layout.itemContainer.appendChild(t);e.afterRender()},processError:function(e,t){e=e||{};var i=e.message||null;var n=e.description||null;if(BX.type.isArray(e.errors)&&e.errors.length){if(e.errors[0].code===1e3&&!e.message){i=BX.message("JS_UI_VIEWER_ITEM_TRANSFORMATION_TIMEOUT")}}this.hideCurrentItem();this.hideLoading();var o=BX.create("div",{props:{className:"ui-viewer-inner-content-wrapper"}});var r=t.getTitle();if(r){o.appendChild(BX.create("div",{props:{className:"viewer-inner-caption"},text:r}))}o.appendChild(this.getErrorBlock({title:i,description:n}));this.layout.itemContainer.appendChild(o)},hideErrorBlock:function(){if(this.layout.error){BX.remove(this.layout.error)}},getErrorBlock:function(e){this.hideErrorBlock();e=e||{};var t=e.title||BX.message("JS_UI_VIEWER_DEFAULT_ERROR_TITLE");var i=e.description;this.layout.error=BX.create("div",{props:{className:"ui-viewer-error"},style:{maxWidth:i?"440px":null},children:[BX.create("div",{props:{className:"ui-viewer-error-title"},text:t}),BX.create("div",{props:{className:"ui-viewer-error-text"},html:i||""})]});return this.layout.error},convertItemActionsToPanelItems:function(e){return e.getActions().map(function(t){if(BX.type.isFunction(t.action)){var i=t.action;t.onclick=function(t,n){i.call(this,e)}.bind(this)}return t},this)},refineItemActions:function(item){var defaultActions={download:{id:"download",type:"download",text:BX.message("JS_UI_VIEWER_ITEM_ACTION_DOWNLOAD"),href:item.src,buttonIconClass:"ui-btn-icon-download"},edit:{id:"edit",type:"edit",text:BX.message("JS_UI_VIEWER_ITEM_ACTION_EDIT"),buttonIconClass:"ui-btn-icon-edit"},share:{id:"share",type:"share",text:BX.message("JS_UI_VIEWER_ITEM_ACTION_SHARE"),buttonIconClass:"ui-btn-icon-share"},info:{id:"info",type:"info",text:"",buttonIconClass:"ui-btn-icon-info ui-action-panel-item-last"},delete:{id:"delete",type:"delete",text:BX.message("JS_UI_VIEWER_ITEM_ACTION_DELETE"),buttonIconClass:"ui-btn-icon-remove"}};return item.getNakedActions().map(function(action){if(defaultActions[action.type]){action=BX.mergeEx(defaultActions[action.type],action)}if(!action.id){action.id=action.type}if(!action.action&&action.href){action.action=function(){document.location=action.href}}if(BX.type.isArray(action.items)){action.items.forEach(function(e){if(BX.type.isString(e.onclick)){e.onclick=new Function("event","popupItem",e.onclick)}})}if(BX.type.isString(action.action)){var params=action.params||{};var actionString=action.action;action.action=function(item,additionalParams){try{var fn=eval(actionString);fn.call(this,item,params,additionalParams)}catch(e){console.log(e)}}.bind(this)}return action},this)},getLoader:function(e){if(!this.layout.loader){this.layout.loader=BX.create("div",{props:{className:"ui-viewer-loader"},style:{zIndex:-1},children:[this.layout.loaderContainer=BX.create("div",{props:{className:"ui-viewer-loader-container"}}),this.layout.loaderText=BX.create("div",{props:{className:"ui-viewer-loader-text"},text:""})]});var t=new BX.Loader({size:130});t.show(this.layout.loaderContainer)}return this.layout.loader},getPrevButton:function(){if(!this.layout.prev){this.layout.prev=BX.create("div",{props:{className:"ui-viewer-prev"}})}return this.layout.prev},getNextButton:function(){if(!this.layout.next){this.layout.next=BX.create("div",{props:{className:"ui-viewer-next"}})}return this.layout.next},getCloseButton:function(){if(!this.layout.close){this.layout.close=BX.create("div",{props:{className:"ui-viewer-close"},html:'<div class="ui-viewer-close-icon"></div>'})}return this.layout.close},isOpen:function(){return this._isOpen},open:function(e){this.adjustZindex();document.body.appendChild(this.getViewerContainer());this.show(e);this.showPanel();this.bindEvents();this._isOpen=true},getPanelWrapper:function(){if(!this.layout.panel){this.layout.panel=BX.create("div",{props:{className:"ui-viewer-panel"}})}return this.layout.panel},showPanel:function(){this.actionPanel.layout.container.style.zIndex="9999999";this.actionPanel.layout.container.style.background="none";this.actionPanel.draw();this.actionPanel.showPanel()},hideCurrentItem:function(){BX.cleanNode(this.layout.itemContainer)},updateControls:function(){if(!this.allowToUseCycleMode()&&this.currentIndex+1>=this.items.length){BX.addClass(this.getNextButton(),"ui-viewer-navigation-hide")}else{BX.removeClass(this.getNextButton(),"ui-viewer-navigation-hide")}if(!this.allowToUseCycleMode()&&this.currentIndex===0){BX.addClass(this.getPrevButton(),"ui-viewer-navigation-hide")}else{BX.removeClass(this.getPrevButton(),"ui-viewer-navigation-hide")}},getCurrentItem:function(){return this.getItemByIndex(this.currentIndex)},getIndexByNode:function(e){var t=null;this.items.forEach(function(i,n){if(i.sourceNode===e){t=n}});return t},getItemByIndex:function(e){e=parseInt(e,10);BX.onCustomEvent("BX.UI.Viewer.Controller:onGetItemByIndex",[this,e]);if(e<0||e-1>this.items.length){return null}return this.items[e]},handleClickOnItemContainer:function(e){if(this.getCurrentItem()instanceof BX.UI.Viewer.Image){this.showNext()}},allowToUseCycleMode:function(){var e=this.cycleMode;var t=this.getCurrentItem().getGroupBy();if(this.optionsByGroup[t]&&this.optionsByGroup[t].hasOwnProperty("cycleMode")){e=this.optionsByGroup[t].cycleMode}return this.items.length>1&&e},showNext:function(){var e=this.currentIndex+1;if(this.allowToUseCycleMode()&&e>=this.items.length){e=0}this.show(e)},showPrev:function(){var e=this.currentIndex-1;if(this.allowToUseCycleMode()&&e===-1){e=this.items.length-1}this.show(e)},close:function(){this._isOpen=false;BX.onCustomEvent("BX.UI.Viewer.Controller:onClose",[this]);BX.addClass(this.layout.container,"ui-viewer-hide");BX.bind(this.layout.container,"transitionend",function(){BX.remove(this.layout.container);BX.removeClass(this.layout.container,"ui-viewer-hide");BX.unbindAll(this.layout.container);this.actionPanel.hidePanel();this.unLockScroll();this.unbindEvents()}.bind(this))},showLoading:function(e){e=e||{};this.layout.inner.appendChild(this.getLoader());this.setTextOnLoading(e.text||"")},setTextOnLoading:function(e){this.layout.loaderText.textContent=e},hideLoading:function(){BX.remove(this.layout.loader)},lockScroll:function(){BX.addClass(document.body,"ui-viewer-lock-body")},unLockScroll:function(){BX.removeClass(document.body,"ui-viewer-lock-body")},adjustViewerHeight:function(){if(!this.layout.container)return;this.layout.container.style.height=document.documentElement.clientHeight+"px"},getViewerContainer:function(){if(!this.layout.container){this.layout.container=BX.create("div",{props:{className:"ui-viewer"},style:{zIndex:this.zIndex,height:window.clientHeight+"px"},children:[this.layout.inner=BX.create("div",{props:{className:"ui-viewer-inner"},children:[this.getItemContainer()]}),this.getCloseButton(),this.getPrevButton(),this.getNextButton(),this.getPanelWrapper()]})}return this.layout.container},getItemContainer:function(){if(!this.layout.itemContainer){this.layout.itemContainer=BX.create("div",{props:{className:"ui-viewer-inner-content"}})}return this.layout.itemContainer},handleTouchStart:function(e){var t=e.changedTouches[0];this.swipeDirection=null;this.startX=t.pageX;this.startY=t.pageY;this.startTime=(new Date).getTime();e.preventDefault()},handleTouchEnd:function(e){var t=e.changedTouches[0];var i=300;var n=80;var o=100;var r=t.pageX-this.startX;var s=t.pageY-this.startY;var a=(new Date).getTime()-this.startTime;if(a<=i){if(Math.abs(r)>=n&&Math.abs(s)<=o){this.swipeDirection=r<0?"left":"right"}else if(Math.abs(s)>=n&&Math.abs(r)<=o){this.swipeDirection=s<0?"up":"down"}}switch(this.swipeDirection){case"up":case"left":this.showPrev();break;case"down":case"right":this.showNext();break}e.preventDefault()},isOnTop:function(){if(!this.isOpen()){return false}if(!BX.getClass("BX.SidePanel.Instance")||!BX.SidePanel.Instance.getTopSlider()){return true}return this.getZindex()>BX.SidePanel.Instance.getTopSlider().getZindex()},handleKeyPress:function(e){if(!this.isOnTop()){return}switch(e.code){case"Space":case"ArrowRight":case"PageDown":case"ArrowDown":this.showNext();e.preventDefault();e.stopPropagation();break;case"ArrowLeft":case"PageUp":case"ArrowUp":this.showPrev();e.preventDefault();e.stopPropagation();break;case"Escape":this.close();e.preventDefault();break}},setOptionsByGroup:function(e,t){this.optionsByGroup[e]=t;return this}};BX.UI.Viewer.buildItemByTypeAndNode=function(e,t){var i=new e;if(!(i instanceof BX.UI.Viewer.Item)){throw new Error("BX.UI.Viewer.buildItemByTypeAndNode: 'item' has to be instance of BX.UI.Viewer.Item.")}i.setPropertiesByNode(t);i.bindSourceNode(t);i.setActions(BX.UI.Viewer.Instance.refineItemActions(i));return i};BX.UI.Viewer.buildItemByNode=function(e){if(!BX.type.isDomNode(e)){throw new Error("BX.UI.Viewer.buildItemByNode: 'node' has to be DomNode.")}var t=e.dataset.viewerType;if(!t&&e.tagName.toLowerCase()==="img"){t="image"}switch(t){case"image":return BX.UI.Viewer.buildItemByTypeAndNode(BX.UI.Viewer.Image,e);case"plainText":return BX.UI.Viewer.buildItemByTypeAndNode(BX.UI.Viewer.PlainText,e);case"unknown":return BX.UI.Viewer.buildItemByTypeAndNode(BX.UI.Viewer.Unknown,e);case"video":return BX.UI.Viewer.buildItemByTypeAndNode(BX.UI.Viewer.Video,e);case"document":return BX.UI.Viewer.buildItemByTypeAndNode(BX.UI.Viewer.Document,e)}if(!e.dataset.viewerTypeClass){throw new Error("BX.UI.Viewer.buildItemByNode: there is no data-viewer-type or data-viewer-type-class")}if(!BX.getClass(e.dataset.viewerTypeClass)){throw new Error("BX.UI.Viewer.buildItemByNode: could not find class "+e.dataset.viewerTypeClass)}return BX.UI.Viewer.buildItemByTypeAndNode(BX.getClass(e.dataset.viewerTypeClass),e)};BX.UI.Viewer.bind=function(e,t){if(!BX.type.isDomNode(e)){throw new Error("BX.UI.Viewer.bind: 'container' has to be DomNode.")}if(!BX.type.isPlainObject(t)&&!BX.type.isFunction(t)){t=function(e){return BX.type.isElementNode(e)&&e.dataset.hasOwnProperty("viewer")}}BX.bindDelegate(e,"click",t,function(i){var n=BX.findChildren(e,t,true);var o=0;var r=BX.getEventTarget(i);var s=n.map(function(e,t){if(e===r){o=t}return BX.UI.Viewer.buildItemByNode(e)});BX.UI.Viewer.Instance.setItems(s).then(function(){BX.UI.Viewer.Instance.open(o)});i.preventDefault()})};var instance=null;Object.defineProperty(BX.UI.Viewer,"Instance",{enumerable:false,get:function(){if(window.top!==window&&BX.getClass("window.top.BX.UI.Viewer.Instance")){return window.top.BX.UI.Viewer.Instance}if(instance===null){instance=new BX.UI.Viewer.Controller({})}return instance}});window.document.addEventListener("click",function(e){if(window.top!==window&&!BX.getClass("window.top.BX.UI.Viewer.Instance")){top.BX.loadExt("ui.viewer").then(function(){top.BX.UI.Viewer.Instance.handleDocumentClick(e)})}else{top.BX.UI.Viewer.Instance.handleDocumentClick(e)}},true);if(window.top!==window&&!BX.getClass("window.top.BX.UI.Viewer.Instance")){top.BX.loadExt("ui.viewer")}})();
//# sourceMappingURL=ui.viewer.map.js